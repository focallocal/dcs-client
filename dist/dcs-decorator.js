!function(){"use strict";const e={inIFrame:()=>{try{return window.self!==window.top}catch(e){return!0}}};e.dom={onDOMReady:()=>new Promise(e=>{"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e)}),forEach(e,t,n){const s=[...e];for(let e=0;e<s.length;e++)t.call(n||window,s[e],e)},wrap:(e,t)=>(e.parentNode.insertBefore(t,e),t.appendChild(e),t),wrapAll(e,t){if(e&&e.length){const n=Array.prototype.slice.call(e);n[0].parentNode.insertBefore(t,n[0]),n.forEach(e=>t.appendChild(e))}return t},createElement(e){const t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}};var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},i=function(){function e(){n(this,e),this._listeners={}}return s(e,[{key:"on",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._listeners[e]||(this._listeners[e]=[]),t._priority=parseInt(n)||0,-1===this._listeners[e].indexOf(t)&&(this._listeners[e].push(t),this._listeners[e].length>1&&this._listeners[e].sort(this.listenerSorter))}},{key:"listenerSorter",value:function(e,t){return e._priority-t._priority}},{key:"off",value:function(e,t){if(void 0!==this._listeners[e])if(void 0!==t){var n=this._listeners[e].indexOf(t);-1<n&&this._listeners[e].splice(n,1)}else delete this._listeners[e]}},{key:"trigger",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e&&(e={type:e,data:"object"===(void 0===n?"undefined":t(n))&&null!==n?n:{}}),void 0!==this._listeners[e.type])for(var s=this._listeners[e.type].length-1;s>=0;s--)this._listeners[e.type][s](e)}},{key:"destroy",value:function(){this._listeners={}}}]),e}(),r=function(e){function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100*Math.random()|0;n(this,r);var t=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return t.id="BELLHOP:"+e,t.connected=!1,t.isChild=!0,t.connecting=!1,t.origin="*",t._sendLater=[],t.iframe=null,t.receive=t.receive.bind(t),t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(r,i),s(r,[{key:"receive",value:function(e){if(this.target===e.source)if("connected"===e.data)this.onConnectionReceived(e.data);else{var n=e.data;if("string"==typeof n)try{n=JSON.parse(n)}catch(e){console.error("Bellhop error: ",e)}this.connected&&"object"===(void 0===n?"undefined":t(n))&&n.type&&this.trigger(n)}}},{key:"onConnectionReceived",value:function(e){this.connecting=!1,this.connected=!0,this.isChild||this.target.postMessage(e,this.origin);for(var t=0;t<this._sendLater.length;t++){var n=this._sendLater[t],s=n.type,o=n.data;this.send(s,o)}this._sendLater.length=0,this.trigger("connected")}},{key:"connect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"*";this.connecting||(this.disconnect(),this.connecting=!0,e instanceof HTMLIFrameElement&&(this.iframe=e),this.isChild=void 0===e,this.supported=!0,this.isChild&&(this.supported=window!=e),this.origin=t,window.addEventListener("message",this.receive),this.isChild&&(window===this.target?this.trigger("failed"):this.target.postMessage("connected",this.origin)))}},{key:"disconnect",value:function(){this.connected=!1,this.connecting=!1,this.origin=null,this.iframe=null,this.isChild=!0,this._sendLater.length=0,window.removeEventListener("message",this.receive)}},{key:"send",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"!=typeof e)throw"The event type must be a string";var n={type:e,data:t};this.connecting?this._sendLater.push(n):this.target.postMessage(JSON.stringify(n),this.origin)}},{key:"fetch",value:function(e,t){var n=this,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!this.connecting&&!this.connected)throw"No connection, please call connect() first";this.on(e,function e(s){o&&n.off(s.type,e),t(s)}),this.send(e,s)}},{key:"respond",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.on(e,function o(i){s&&t.off(i.type,o),t.send(e,"function"==typeof n?n():n)})}},{key:"destroy",value:function(){(function e(t,n,s){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,n);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,s)}if("value"in o)return o.value;var r=o.get;return void 0!==r?r.call(s):void 0})(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"destroy",this).call(this),this.disconnect(),this._sendLater.length=0}},{key:"target",get:function(){return this.isChild?window.parent:this.iframe.contentWindow}}]),r}();const c=new class{constructor(){this._bellhop=new r,this._timer=null,this._onConnected=null,this._bellhop.on("connected",()=>{this._timer&&(clearTimeout(this._timer),this._timer=null),this._onConnected&&this._onConnected()})}connect({discourseOrigin:t,onConnected:n,timeout:s,onTimeout:o}){if(!e.inIFrame())throw new Error("comToPlugin must be used in an iframe");this.disconnect(),this._onConnected=n,this._timer=s?setTimeout(()=>{o&&o()},s):null,this._bellhop.connect(void 0,t)}disconnect(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._bellhop.disconnect()}isConnected(){return this._bellhop.connected}onDiscourseRoutePushed(e){this._bellhop.on("m2",t=>e(t.data))}onCountsChanged(e){this._bellhop.on("m3",t=>e(t.data))}postSetDiscourseRoute({route:e,mode:t,clientContext:n}){this._bellhop.send("m4",arguments[0])}postSetRouteProps({category:e,discourseTitle:t,error:n}){this._bellhop.send("m6",arguments[0])}postSetRedirects(e){this._bellhop.send("m7",e)}},a=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight)-window.innerHeight;function d(e,t){"UP"===t?0===window.scrollY&&e.preventDefault():"DOWN"===t&&window.scrollY===a&&e.preventDefault()}window.addEventListener("wheel",e=>{e.deltaY<0?d(e,"UP"):e.deltaY>0&&d(e,"DOWN")},{passive:!1}),document.addEventListener("keydown",e=>{e.shiftKey||e.altKey||e.ctrlKey||e.metaKey||("ArrowUp"!==e.code&&"PageUp"!==e.code||d(e,"UP"),"ArrowDown"!==e.code&&"PageDown"!==e.code||d(e,"DOWN"))});const l=".dcs-icons, .dcs-trigger.dcs-no-balloon .dcs-trigger-span, .dcs-trigger.dcs-no-balloon.dcs-no-span";function u(e){const t=e.getBoundingClientRect();t.top<window.innerHeight&&t.bottom>=0||e.scrollIntoView()}function h(){const t=document.getElementsByClassName("dcs-trigger"),n={};e.dom.forEach(t,e=>{const t=e.dataset.dcsTriggerId;n[t]=n[t]||!!e.dataset.dcsHighlightable});const s=Object.keys(n).filter(e=>!n[e]).map(e=>({src:{layout:2,triggerId:e},dest:{layout:0,pageName:"@SAME_AS_SRC@"}}));c.postSetRedirects(s)}const g=new class{constructor(){this.selTriggerNode=null,this.resizeTimer=null,this.currentRoute=null,c.onDiscourseRoutePushed(this._onDiscourseRoutePushed.bind(this)),c.onCountsChanged(({counts:e})=>console.log("counts: ",e))}connect({discourseOrigin:e,timeout:t}){return new Promise((n,s)=>{this.resolveConnect=n,c.connect({discourseOrigin:e,timeout:t,onTimeout:()=>s("timeout")})})}parseDom({descr:t,pageName:n,discourseOrigin:s,counts:o}){const i=t.pages.find(e=>e.name===n);return new MutationObserver(e=>{for(let o of e)for(let e of o.addedNodes){if(e.nodeType!==Node.ELEMENT_NODE)return;const o=[..."A"===e.tagName?[e]:[],...e.getElementsByTagName("A")];for(let e of o)console.log("Docuss experimental feature: a link has been dynamically added",e),this._transformLink({a:e,descr:t,discourseOrigin:s,page:i});const r=[...e.matches(l)?[e]:[],...e.querySelectorAll(l)];for(let e of r)console.log("Docuss experimental feature: a trigger target has been dynamically added",e),this._addTriggerClickEvent({node:e,pageName:n});const c=[...e.classList.contains("dcs-trigger")?[e]:[],...e.getElementsByClassName("dcs-trigger")];c.length&&(console.log("Docuss experimental feature: one or several triggers have been dynamically added",c),h())}}).observe(document.documentElement,{childList:!0,subtree:!0}),window.addEventListener("click",()=>{!window.getSelection().toString()&&this.selTriggerNode&&this.selTriggerNode.dataset.dcsHighlightable&&(this._selectTriggers(null),c.postSetDiscourseRoute({route:{layout:0,pageName:n},mode:"PUSH",clientContext:!0}))}),window.addEventListener("resize",e=>{null!==this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(()=>{this.resizeTimer=null,this.selTriggerNode&&u(this.selTriggerNode)},100)}),e.dom.onDOMReady().then(()=>{e.dom.forEach(document.getElementsByTagName("a"),e=>{this._transformLink({a:e,descr:t,discourseOrigin:s,page:i})}),e.dom.forEach(document.querySelectorAll(l),e=>{this._addTriggerClickEvent({node:e,pageName:n})}),h(),this.runReady=!0,this.delayedRoute&&this._onDiscourseRoutePushed({route:this.delayedRoute})})}_onDiscourseRoutePushed({route:e,descr:t,counts:n,clientContext:s,origin:o}){if(this.currentRoute=e,this.resolveConnect)return this.resolveConnect({descr:t,pageName:e.pageName,discourseOrigin:o,counts:n}),delete this.resolveConnect,this.runReady=!1,void(this.delayedRoute=e);if(this.runReady){if(s||this._selectTriggers(e.triggerId),2===e.layout||3===e.layout){const e=this.selTriggerNode&&this.selTriggerNode.dataset.dcsCategory||document.documentElement.dataset.dcsCategory,t=this.selTriggerNode&&this.selTriggerNode.dataset.dcsDiscourseTitle||document.documentElement.dataset.dcsDiscourseTitle;c.postSetRouteProps({category:e,discourseTitle:t})}}else this.delayedRoute=e}_addTriggerClickEvent({node:e,pageName:t}){e.addEventListener("click",e=>{if(window.getSelection().toString())return;const n=e.target.closest(".dcs-trigger"),s=n.dataset.dcsTriggerId;this._selectTriggers(s),c.postSetDiscourseRoute({route:{layout:3,pageName:n.dataset.dcsPageName||t,triggerId:s,interactMode:n.dataset.dcsInteractMode},mode:"PUSH",clientContext:!0}),e.stopPropagation()})}_selectTriggers(t){if(!this.runReady)throw new Error("should be ready");if(this.selTriggerNode=null,e.dom.forEach(document.getElementsByClassName("dcs-highlighted"),e=>e.classList.remove("dcs-highlighted")),!t)return;const n=document.querySelectorAll(`.dcs-trigger[data-dcs-trigger-id="${t}"]`);n.length?(this.selTriggerNode=null,e.dom.forEach(n,e=>{if(e.dataset.dcsHighlightable){e.classList.add("dcs-highlighted");const t=e.closest(".dcs-subsec");t&&t.classList.add("dcs-highlighted"),this.selTriggerNode=this.selTriggerNode||e}}),this.selTriggerNode=this.selTriggerNode||n[0],setTimeout(()=>u(this.selTriggerNode),700)):c.postSetRouteProps({error:error})}_transformLink({a:e,descr:t,discourseOrigin:n,page:s}){if(!e.href||"#"===e.href||"#!"===e.href||e.href.startsWith("javascript:"))return;"_parent"!==e.target&&"_top"!==e.target||delete e.target,"discourse"===e.hostname&&(e.href=new URL(e.pathname+e.search+e.hash,n));const o=s.url,i=e.getAttribute("href").trim(),r=new URL(i,o);r.hash="";const a=t.pages.find(e=>e.url.split("#")[0]===r.href);if(!a&&e.origin!==n)return void("_blank"!==e.target&&(e.target="_parent"));let d;if(a)e.href=n+"/docuss/"+a.name+e.hash,d={layout:0,pageName:a.name,hash:e.hash};else if(e.pathname.startsWith("/docuss/")){const t=e.pathname.substring("/docuss/".length);d={layout:0,pageName:t,hash:e.hash}}else{if("/"===e.pathname||"/docuss"===e.pathname)return void("_blank"!==e.target&&(e.target="_parent"));d={layout:1,pathname:e.pathname,hash:e.hash}}"_blank"!==e.target&&e.addEventListener("click",t=>{if(!t.ctrlKey)if(t.preventDefault(),t.stopPropagation(),d.pageName===s.name){location.hash=e.hash;const t=Object.assign({},this.currentRoute,{hash:e.hash});c.postSetDiscourseRoute({route:t,mode:"REPLACE",clientContext:!0})}else c.postSetDiscourseRoute({route:d,mode:"PUSH",clientContext:!0})})}};e.inIFrame()?(console.log("Docuss Decorator - Initializing..."),g.connect({discourseOrigin:"*",timeout:1e4}).then(t=>(function({descr:t,pageName:n,discourseOrigin:s,counts:o}){const i=t.clientData&&t.clientData.decorator;if(!i)throw"No decorator found in json descriptor";f=t.dcsTag;const r=(i.injectCss||[]).reduce((e,t)=>_({pageNames:t.pageNames,pageName:n})?e.concat(t.css):e,[]);if(r.length){const e=document.createElement("style");e.type="text/css",e.innerHTML=r.join("\n"),document.head.appendChild(e)}const c=(i.pageProperties||[]).filter(e=>_({pageNames:e.pageNames,pageName:n})).pop(),a=c&&c.category||i.category,d=c&&c.discourseTitle||i.discourseTitle;a&&(document.documentElement.dataset.dcsCategory=a);d&&(document.documentElement.dataset.dcsDiscourseTitle=d);const l=(i.injectTriggers||[]).filter(e=>_({pageNames:e.pageNames,pageName:n})),u=o.filter(e=>e.pageName===n);return e.dom.onDOMReady().then(()=>(function(t,n){if((!!document.querySelectorAll(".dcs-subsec, .dcs-trigger, .dcs-icons, .dcs-badge")).length)throw"The page already contains Docuss markup";p=[],m=t.reduce((e,t)=>Array.isArray(t.ids)?e.concat(t.ids):e,[]),t.forEach(t=>(function(t,n){if(!t.ui.subsection)return void y(t,null,n);const s=t.ui.subsection,o=document.querySelectorAll(s.begin);o.length||console.log(`Docuss Decorator Warning - Found nothing with begin="${s.begin}"`),e.dom.forEach(o,o=>{for(;!o.previousElementSibling&&o.parentNode&&1===o.parentNode.querySelectorAll(s.begin).length&&(!s.end||0===o.parentNode.querySelectorAll(s.end).length);)o=o.parentNode;const i=s.begin+(s.end?","+s.end:""),r=[o];let c=o.nextSibling;for(;c&&(1!==c.nodeType||!c.matches(i)&&!c.querySelectorAll(i).length);)r.push(c),c=c.nextSibling;const a=document.createElement("div");a.classList.add("dcs-subsec"),e.dom.wrapAll(r,a),y(t,a,n)})})(t,n)),p.length&&console.log('Docuss Decorator Warning - Those triggers with id="@GENERATE_FROM_HTML_ID@" were assigned generated ids because no html id was found:',p)}(l,u),console.log("Docuss Decorator - Ready"),{descr:t,pageName:n,discourseOrigin:s,counts:o}))})(t)).then(e=>g.parseDom(e)).catch(e=>{if("string"!=typeof e)throw e;console.log("Docuss Decorator Error - "+e)})):console.log("Docuss Decorator - Could not run, as the page is not displayed in a Docuss iframe");let m,p,f=null;function y(t,n,s){const o=(n||document).querySelectorAll(t.ui.cssSelector);e.dom.forEach(o,(o,i)=>{let r;if(r="@GENERATE_FROM_HTML_ID@"===t.ids[0]?v(o,n,!0):"@GENERATE@"===t.ids[0]?v(o,null,!1):t.ids[i%t.ids.length],o.dataset.dcsTriggerId=r,o.dataset.dcsInteractMode=t.interactMode,t.category&&(o.dataset.dcsCategory=t.category),t.discourseTitle&&(o.dataset.dcsDiscourseTitle=t.discourseTitle),t.ui.highlightable&&(o.dataset.dcsHighlightable=!0),o.classList.add("dcs-trigger"),t.ui.insertTextSpan){const t=document.createTreeWalker(o,NodeFilter.SHOW_TEXT,null,!1);let n;for(;n=t.nextNode();)n.data.trim()&&e.dom.wrap(n,e.dom.createElement('<span class="dcs-trigger-span"></span>'))}else o.classList.add("dcs-no-span");let c="";if(t.ui.insertBalloon?c+='<div class="dcs-balloon"></div>':o.classList.add("dcs-no-balloon"),t.ui.insertCountBadge){const e=s.find(e=>e.triggerId===r);e&&0!==e.count&&(c+=` \n        <div class="dcs-badge" title="This section has ${e.count} topic(s)">\n          ${e.count}\n        </div>\n      `)}c&&o.appendChild(e.dom.createElement(`\n        <span class="dcs-icons" title="Click to discuss this subsection">\n          ${c}\n        </span>\n      `))})}function v(e,t,n){let s=n?function(e,t){if(e.id)return e.id;const n=e.querySelectorAll('[id]:not([id=""])');if(n.length)return n[0].id;let s=e.parentElement;for(;s&&!s.getElementsByClassName("dcs-trigger").length;){if(s.id)return s.id;s=s.parentElement}if(t){const e=t.querySelectorAll('[id]:not([id=""])');if(e.length)return e[0].id}return null}(e,t):null;s||(s=`gen${p.length}`,p.push({Text:e.innerText.trim(),"Generated Id":s}));let o=function(e){const t=e.substring(0,f.maxTriggerIdLength).replace(b,"_");return f.forceLowercase?t.toLowerCase():t}(s);if(m.includes(o)){const e=f.maxTriggerIdLength,t=o;for(let n=1;;++n){const s=n.toString();if(s.length>e)throw new Error("too many duplicated html ids");if(o=t.substring(0,e-s.length)+s,!m.includes(o))break}}return m.push(o),o}function _({pageNames:e,pageName:t}){return e.find(e=>e.endsWith("*")?t.startsWith(e.slice(0,-1)):e===t)}const b=/[^0-9A-Za-z_]/g}();
//# sourceMappingURL=dcs-decorator.js.map
